{"version":3,"file":"single-spa.js","sources":["../../src/start.js","../../src/applications/app.helper.js","../../src/lifecycles/lifecycle.helpers.js","../../src/lifecycles/load.js","../../src/lifecycles/unmount.js","../../src/lifecycles/bootstrap.js","../../src/lifecycles/mount.js","../../src/navigations/reroute.js","../../src/applications/app.js"],"sourcesContent":["import { reroute } from \"./navigations/reroute\";\n\n//状态控制\nexport let started = false\n//挂载子应用\nexport function start(){\n  started = true\n  reroute()\n}","// single-spa 状态\nexport const NOT_LOADED = 'NOT_LOADED'\nexport const LOAD_ERROR = 'LOAD_ERROR'\nexport const LOADING_SOURCE_CODE = 'LOADING_SOURCE_CODE'\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED'\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING'\nexport const NOT_MOUNTED = 'NOT_MOUNTED'\nexport const MOUNTING = 'MOUNTING'\nexport const MOUNTED = 'MOUNTED'\nexport const UPDATING = 'UPDATING'\nexport const UNMOUNTING = 'UNMOUNTING'\nexport const UNLOADING = 'UNLOADING'\nexport const LOAD_ERR = 'LOAD_ERR'\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN'\n\n// 当前应用是否被激活\nexport function isActive (app) {\n  return app.status === MOUNTED\n}\n//当前应用是否需要激活\nexport function shouldBeActive (app) {\n  return app.activeWhen(window.location)\n}\n","\nexport function flattenFnArray (appOrParcel, lifecycle) {\n  let fns = appOrParcel[lifecycle] || [];\n  fns = Array.isArray(fns) || []\n  if (fns.length === 0) {\n    fns = [() => Promise.resolve()];\n  }\n  return (props) => fns.reduce((resultPromise, fn, index) => {\n    return resultPromise.then(() => fn(props))\n  }, Promise.resolve())\n}","import { LOADING_SOURCE_CODE, NOT_BOOTSTRAPPED, NOT_LOADED } from \"../applications/app.helper\";\nimport { flattenFnArray } from \"./lifecycle.helpers\";\n\n/**\n * 异步加载 app\n */\nexport async function toLoadPromise(app){\n  if (app.status !== NOT_LOADED && app.status !== LOAD_ERROR) {\n    return app;\n  }\n  app.status = LOADING_SOURCE_CODE\n  // 各种验证合法性的方法\n  // 调用 loadApp 返回约定的生命周期方法\n  let appOpts = await app.loadApp(app.customProps)\n  app.status = NOT_BOOTSTRAPPED\n  app.bootstarp = flattenFnArray(appOpts, 'bootstarp')\n  app.mount = flattenFnArray(appOpts, 'mount')\n  app.unmount = flattenFnArray(appOpts, 'unmount')\n  app.unload = flattenFnArray(appOpts, 'unload')\n  delete app.loadPromise;\n  return app\n}","export async function toUnmountPromise () {\n\n}","import { BOOTSTRAPPING, NOT_BOOTSTRAPPED, NOT_MOUNTED } from \"../applications/app.helper\";\n\nexport async function toBootstrapPromise(appOrParcel){\n  if (appOrParcel.status !== NOT_BOOTSTRAPPED) {\n    return appOrParcel;\n  }\n  appOrParcel.status = BOOTSTRAPPING\n  await appOrParcel.bootstrap(appOrParcel.customProps)\n  appOrParcel.status = NOT_MOUNTED\n  return appOrParcel\n}","import { MOUNTED, MOUNTING, NOT_MOUNTED } from \"../applications/app.helper\";\n\nexport async function toMountPromise(){\n  if (appOrParcel.status !== NOT_MOUNTED) {\n    return appOrParcel;\n  }\n  appOrParcel.status = MOUNTING\n  await appOrParcel.mount(appOrParcel.customProps)\n  appOrParcel.status = MOUNTED\n  return appOrParcel\n}","import { started } from \"../start\";\nimport { getAppChanges } from '../applications/app'\nimport { toLoadPromise } from \"../lifecycles/load\";\nimport { toUnmountPromise } from \"../lifecycles/unmount\";\nimport { toBootstrapPromise } from \"../lifecycles/bootstrap\";\nimport { toMountPromise } from \"../lifecycles/mount\";\n\nexport function reroute(){\n  const { appsToLoad, appsToMount, appsToUnload, appsToUnmount } = getAppChanges()\n  console.log('appsToLoad, appsToMount, appsToUnload, appsToUnmount', appsToLoad, appsToMount, appsToUnload, appsToUnmount)\n  if (started) {\n    // app装载\n    return performAppChanges()\n  } else {\n    // 注册应用 预先加载\n    return loadApps()\n  }\n  // 预加载应用\n  async function loadApps(){\n    const apps = await Promise.all(appsToLoad.map(toLoadPromise))\n    console.log('apps',apps)\n  }\n  // 根据路径加载应用\n  async function performAppChanges(){\n    // 卸载需要卸载的应用\n    let unmountPromise = appsToUnmount.map(toUnmountPromise)\n    // 加载应用\n    appsToLoad.map(async (app) => {\n      //加载\n      app = await toLoadPromise(app)\n      //启动\n      app = await toBootstrapPromise(app)\n      //装载\n      app = await toMountPromise(app)\n      return app\n    })\n    // 挂载已加载的应用\n    appsToMount.map(async (app) => {\n      app = await toBootstrapPromise(app)\n      app = await toMountPromise(app)\n      return app\n    })\n\n  }\n\n}\n","import { reroute } from \"../navigations/reroute\"\nimport {\n  NOT_LOADED, SKIP_BECAUSE_BROKEN, LOAD_ERROR, LOADING_SOURCE_CODE,\n  MOUNTED, NOT_MOUNTED, NOT_BOOTSTRAPPED,\n  shouldBeActive\n} from \"./app.helper\"\n\n// 子应用列表\nconst apps = []\n\n/**\n * registerApplication 注册加载子应用\n * @export\n * @param {*} appName\n * @param {*} loadApp\n * @param {*} activeWhen\n * @param {*} customProps\n */\nexport function registerApplication (appName, loadApp, activeWhen, customProps) {\n  apps.push({\n    name: appName,\n    loadApp,\n    activeWhen,\n    customProps,\n    status: NOT_LOADED,\n    loadErrorTime: null\n  })\n  // 加载应用\n  reroute()\n}\n\n/**\n * 根据app状态分类\n * @export\n * @returns\n */\nexport function getAppChanges(){\n  const appsToUnload = [],\n  appsToUnmount = [],\n  appsToLoad = [],\n  appsToMount = [];\n\n  const currentTime = new Date().getTime();\n  apps.forEach((app) => {\n    const appShouldBeActive = app.status !== SKIP_BECAUSE_BROKEN && shouldBeActive(app)\n    switch (app.status) {\n      case LOAD_ERROR:\n        if (appShouldBeActive && currentTime - app.loadErrorTime >= 200) {\n          appsToLoad.push(app);\n        }\n        break;\n      case NOT_LOADED:\n      case LOADING_SOURCE_CODE:\n        if (appShouldBeActive) {\n          appsToLoad.push(app);\n        }\n        break;\n      case NOT_BOOTSTRAPPED:\n      case NOT_MOUNTED:\n        if (!appShouldBeActive && getAppUnloadInfo(toName(app))) {\n          appsToUnload.push(app);\n        } else if (appShouldBeActive) {\n          appsToMount.push(app);\n        }\n        break;\n      case MOUNTED:\n        if (!appShouldBeActive) {\n          appsToUnmount.push(app);\n        }\n        break;\n    }\n  })\n  return { appsToUnload, appsToUnmount, appsToLoad, appsToMount };\n}\n"],"names":["LOAD_ERROR"],"mappings":"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"}